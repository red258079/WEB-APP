
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m B√†i Luy·ªán T·∫≠p - EDEXIS</title>
    <link rel="icon" type="image/png" href="/client/public/images/edu.png">
    <link rel="stylesheet" href="/client/public/css/variables.css">
    <script src="/client/public/js/config.js"></script>
    <script src="/client/public/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        .exam-container {
            max-width: var(--container-max-width);
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .exam-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            padding: var(--spacing-lg) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .exam-title {
            font-size: 24px;
            font-weight: 600;
        }

        .exam-body {
            padding: 30px;
        }

        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }

        .question-nav-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .question-nav-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .question-nav-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .question-nav-btn.answered {
            background: #26de81;
            color: white;
            border-color: #26de81;
        }

        .question-content {
            background: #f7fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .question-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .meta-badge {
            padding: 6px 12px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            padding: 15px;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .option.selected {
            background: #eef2ff;
            border-color: #667eea;
        }

        .option input[type="radio"],
        .option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .textarea-answer {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
        }

        .textarea-answer:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            .exam-body {
                padding: 15px;
            }
            
            .question-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="exam-container">
        <div class="exam-header">
            <div>
                <div class="exam-title" id="examTitle">ƒê·ªÅ luy·ªán t·∫≠p</div>
                <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                    T·ªïng s·ªë c√¢u: <span id="totalQuestions">0</span>
                </div>
            </div>
            <button class="btn btn-warning" onclick="submitExam()" style="background: #f39c12;">
                üì§ N·ªôp b√†i
            </button>
        </div>

        <div class="exam-body">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
            </div>

            <div class="question-nav" id="questionNav">
                <!-- Navigation buttons s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
            </div>

            <div id="questionContainer">
                <!-- C√¢u h·ªèi s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()">‚Üê C√¢u tr∆∞·ªõc</button>
                <button class="btn btn-secondary" id="nextBtn" onclick="nextQuestion()">C√¢u sau ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Modal k·∫øt qu·∫£ -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeResultModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">üéâ Ho√†n th√†nh!</h2>
            <div style="font-size: 48px; margin: 20px 0;">
                <span id="resultScore" style="font-weight: bold; color: #667eea;">--</span>
                <span style="color: #666;">/</span>
                <span id="resultTotal" style="color: #666;">--</span>
            </div>
            <p id="resultPercentage" style="font-size: 18px; color: #666; margin-bottom: 20px;"></p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-primary" onclick="goToDashboard()">V·ªÅ trang ch·ªß</button>
                <button class="btn btn-secondary" onclick="closeResultModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

<script>
    const token = localStorage.getItem('token');
    let examData = null;
    let currentQuestionIndex = 0;
    let answers = {};

    document.addEventListener('DOMContentLoaded', async function() {
        if (!token) {
            alert('‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p!');
            window.location.href = './login.html';
            return;
        }

        // L·∫•y practice_exam_id t·ª´ URL
        const urlParams = new URLSearchParams(window.location.search);
        const practiceExamId = urlParams.get('practice_exam_id');
        
        if (!practiceExamId) {
            alert('‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªÅ luy·ªán t·∫≠p!');
            window.location.href = './student_dashboard.html';
            return;
        }

        await loadPracticeExam(practiceExamId);
    });

    async function loadPracticeExam(practiceExamId) {
        try {
            const data = await apiGet(`/api/student/practice/exams/${practiceExamId}/start`);
            examData = data;
            
            document.getElementById('examTitle').textContent = data.exam.exam_name;
            document.getElementById('totalQuestions').textContent = data.exam.total_questions;
            
            loadExam();
        } catch (error) {
            console.error('Error loading practice exam:', error);
            alert(`‚ùå ${error.message || 'L·ªói khi t·∫£i ƒë·ªÅ luy·ªán t·∫≠p'}`);
            window.location.href = './student_dashboard.html';
        }
    }

    function loadExam() {
        const questions = examData.questions;
        const nav = document.getElementById('questionNav');
        
        nav.innerHTML = questions.map((q, i) => 
            `<button class="question-nav-btn" data-index="${i}" onclick="goToQuestion(${i})">${i + 1}</button>`
        ).join('');
        
        updateProgress();
        showQuestion(0);
    }

    function showQuestion(index) {
        if (index < 0 || index >= examData.questions.length) return;
        
        currentQuestionIndex = index;
        const question = examData.questions[index];
        
        const container = document.getElementById('questionContainer');
        
        let optionsHTML = '';
        
        // X·ª≠ l√Ω Essay v√† FillInBlank tr∆∞·ªõc (kh√¥ng c·∫ßn options)
        if (question.question_type === 'Essay' || question.question_type === 'FillInBlank') {
            optionsHTML = `<textarea class="textarea-answer" id="textAnswer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...">${answers[question.question_id] || ''}</textarea>`;
        } else if (question.question_type === 'SingleChoice') {
            // Ki·ªÉm tra c√≥ options kh√¥ng
            if (!question.options || !Array.isArray(question.options) || question.options.length === 0) {
                optionsHTML = '<div style="color: red; padding: 20px; text-align: center;">‚ö†Ô∏è L·ªói: C√¢u h·ªèi kh√¥ng c√≥ ƒë√°p √°n. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.</div>';
            } else {
                optionsHTML = question.options.map((opt, i) => `
                    <div class="option ${answers[question.question_id] === opt.option_id ? 'selected' : ''}" onclick="selectOption(${i})">
                        <input type="radio" name="answer_${question.question_id}" value="${opt.option_id}" 
                               ${answers[question.question_id] === opt.option_id ? 'checked' : ''}>
                        <span>${String.fromCharCode(65 + i)}. ${opt.option_content}</span>
                    </div>
                `).join('');
            }
        } else if (question.question_type === 'MultipleChoice') {
            // Ki·ªÉm tra c√≥ options kh√¥ng
            if (!question.options || !Array.isArray(question.options) || question.options.length === 0) {
                optionsHTML = '<div style="color: red; padding: 20px; text-align: center;">‚ö†Ô∏è L·ªói: C√¢u h·ªèi kh√¥ng c√≥ ƒë√°p √°n. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.</div>';
            } else {
                const savedAnswers = answers[question.question_id] || [];
                optionsHTML = question.options.map((opt, i) => `
                    <div class="option ${savedAnswers.includes(opt.option_id) ? 'selected' : ''}" onclick="toggleOption(${i})">
                        <input type="checkbox" name="answer_${question.question_id}" value="${opt.option_id}"
                               ${savedAnswers.includes(opt.option_id) ? 'checked' : ''}>
                        <span>${String.fromCharCode(65 + i)}. ${opt.option_content}</span>
                    </div>
                `).join('');
            }
        } else {
            // Fallback cho c√°c lo·∫°i c√¢u h·ªèi kh√°c
            optionsHTML = `<textarea class="textarea-answer" id="textAnswer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...">${answers[question.question_id] || ''}</textarea>`;
        }
        
        container.innerHTML = `
            <div class="question-meta">
                <span class="meta-badge">C√¢u ${index + 1}/${examData.questions.length}</span>
                <span class="meta-badge">${question.question_type}</span>
                <span class="meta-badge">${question.difficulty}</span>
                <span class="meta-badge">${question.points} ƒëi·ªÉm</span>
            </div>
            <div class="question-text">${question.question_content}</div>
            <div class="options">${optionsHTML}</div>
        `;
        
        // L∆∞u ƒë√°p √°n text khi thay ƒë·ªïi
        if (question.question_type === 'FillInBlank' || question.question_type === 'Essay') {
            const textarea = document.getElementById('textAnswer');
            if (textarea) {
                textarea.addEventListener('input', (e) => {
                    answers[question.question_id] = e.target.value;
                    updateProgress();
                });
            }
        }
        
        document.querySelectorAll('.question-nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.question-nav-btn[data-index="${index}"]`).classList.add('active');
        
        document.getElementById('prevBtn').disabled = (index === 0);
        document.getElementById('nextBtn').disabled = (index === examData.questions.length - 1);
        
        updateProgress();
    }

    function selectOption(index) {
        const question = examData.questions[currentQuestionIndex];
        const option = question.options[index];
        answers[question.question_id] = option.option_id;
        
        // Update UI
        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        event.currentTarget.querySelector('input').checked = true;
        
        updateProgress();
    }

    function toggleOption(index) {
        const question = examData.questions[currentQuestionIndex];
        const option = question.options[index];
        
        if (!answers[question.question_id]) {
            answers[question.question_id] = [];
        }
        if (!Array.isArray(answers[question.question_id])) {
            answers[question.question_id] = [answers[question.question_id]];
        }
        
        const idx = answers[question.question_id].indexOf(option.option_id);
        if (idx > -1) {
            answers[question.question_id].splice(idx, 1);
            event.currentTarget.classList.remove('selected');
            event.currentTarget.querySelector('input').checked = false;
        } else {
            answers[question.question_id].push(option.option_id);
            event.currentTarget.classList.add('selected');
            event.currentTarget.querySelector('input').checked = true;
        }
        
        updateProgress();
    }

    function goToQuestion(index) {
        showQuestion(index);
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < examData.questions.length - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    }

    function updateProgress() {
        const total = examData.questions.length;
        const answered = Object.keys(answers).length;
        const percentage = total > 0 ? (answered / total) * 100 : 0;
        
        document.getElementById('progressBar').style.width = percentage + '%';
        
        // Update nav buttons
        document.querySelectorAll('.question-nav-btn').forEach((btn, i) => {
            const question = examData.questions[i];
            if (answers[question.question_id]) {
                btn.classList.add('answered');
            } else {
                btn.classList.remove('answered');
            }
        });
    }

    async function submitExam() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i? B·∫°n s·∫Ω kh√¥ng th·ªÉ s·ª≠a l·∫°i sau khi n·ªôp.')) {
            return;
        }
        
        try {
            const result = await apiPost(`/api/student/practice/exams/${examData.exam.practice_exam_id}/submit`, {
                attempt_id: examData.attempt_id,
                answers: answers
            });
            
            // Chuy·ªÉn ƒë·∫øn trang xem k·∫øt qu·∫£ chi ti·∫øt
            window.location.href = `./student_practice_result.html?practice_exam_id=${examData.exam.practice_exam_id}&attempt_id=${examData.attempt_id}`;
        } catch (error) {
            console.error('Error submitting exam:', error);
            alert(`‚ùå ${error.message || 'L·ªói khi n·ªôp b√†i'}`);
        }
    }

    function closeResultModal() {
        document.getElementById('resultModal').style.display = 'none';
    }

    function goToDashboard() {
        window.location.href = './student_dashboard.html';
    }
</script>
</body>
</html>