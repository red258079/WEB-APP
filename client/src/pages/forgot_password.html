<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu√™n M·∫≠t Kh·∫©u - OTP</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 450px;
      padding: 40px;
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .icon {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 30px;
    }

    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .otp-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }

    .otp-input {
      width: 50px;
      height: 55px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s;
    }

    .otp-input:focus {
      outline: none;
      border-color: #667eea;
      transform: scale(1.05);
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #f8f9ff;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .alert.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-error {
      background: #fee;
      color: #c00;
      border: 1px solid #fcc;
    }

    .alert-success {
      background: #efe;
      color: #0a0;
      border: 1px solid #cfc;
    }

    .timer {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 15px 0;
    }

    .timer.active {
      color: #667eea;
      font-weight: 600;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .success-icon {
      width: 80px;
      height: 80px;
      border: 4px solid #4caf50;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }

    .checkmark {
      width: 40px;
      height: 40px;
      border-bottom: 4px solid #4caf50;
      border-right: 4px solid #4caf50;
      transform: rotate(45deg);
      margin-bottom: 10px;
    }

    .back-link {
      text-align: center;
      margin-top: 20px;
    }

    .back-link a {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Alert Messages -->
    <div id="alert" class="alert"></div>

    <!-- Step 1: Nh·∫≠p Email -->
    <div id="step1" class="step active">
      <div class="header">
        <div class="icon">üîí</div>
        <h1>Qu√™n m·∫≠t kh·∫©u?</h1>
        <p class="subtitle">Nh·∫≠p email ƒë·ªÉ nh·∫≠n m√£ x√°c th·ª±c</p>
      </div>

      <form id="emailForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="example@email.com" required>
        </div>

        <button type="submit" class="btn" id="sendOtpBtn">
          G·ª≠i m√£ OTP
        </button>
      </form>

      <div class="back-link">
        <a href="/client/src/pages/login.html">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
      </div>
    </div>

    <!-- Step 2: Nh·∫≠p OTP -->
    <div id="step2" class="step">
      <div class="header">
        <div class="icon">üìß</div>
        <h1>X√°c th·ª±c OTP</h1>
        <p class="subtitle">Nh·∫≠p m√£ 6 s·ªë ƒë√£ g·ª≠i ƒë·∫øn email c·ªßa b·∫°n</p>
      </div>

      <form id="otpForm">
        <div class="otp-container">
          <input type="text" class="otp-input" maxlength="1" data-index="0">
          <input type="text" class="otp-input" maxlength="1" data-index="1">
          <input type="text" class="otp-input" maxlength="1" data-index="2">
          <input type="text" class="otp-input" maxlength="1" data-index="3">
          <input type="text" class="otp-input" maxlength="1" data-index="4">
          <input type="text" class="otp-input" maxlength="1" data-index="5">
        </div>

        <div id="timer" class="timer"></div>

        <button type="submit" class="btn" id="verifyOtpBtn">
          X√°c th·ª±c
        </button>

        <button type="button" class="btn btn-secondary" id="resendOtpBtn" style="display:none;">
          G·ª≠i l·∫°i m√£ OTP
        </button>
      </form>

      <div class="back-link">
        <a href="#" id="backToEmail">‚Üê Thay ƒë·ªïi email</a>
      </div>
    </div>

    <!-- Step 3: ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi -->
    <div id="step3" class="step">
      <div class="header">
        <div class="icon">üîë</div>
        <h1>ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi</h1>
        <p class="subtitle">T·∫°o m·∫≠t kh·∫©u m·ªõi cho t√†i kho·∫£n c·ªßa b·∫°n</p>
      </div>

      <form id="passwordForm">
        <div class="form-group">
          <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="newPassword" placeholder="√çt nh·∫•t 6 k√Ω t·ª±" required minlength="6">
        </div>

        <div class="form-group">
          <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
          <input type="password" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required>
        </div>

        <button type="submit" class="btn" id="resetPasswordBtn">
          ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
        </button>
      </form>
    </div>

    <!-- Step 4: Th√†nh c√¥ng -->
    <div id="step4" class="step">
      <div class="header">
        <div class="success-icon">
          <div class="checkmark"></div>
        </div>
        <h1>Th√†nh c√¥ng!</h1>
        <p class="subtitle">M·∫≠t kh·∫©u c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t</p>
      </div>

      <button class="btn" onclick="window.location.href='/client/src/pages/login.html'">
        ƒêƒÉng nh·∫≠p ngay
      </button>
    </div>
  </div>

  <script src="/client/public/js/config.js"></script>
  <script src="/client/public/js/api.js"></script>
  <script>
    // S·ª≠ d·ª•ng apiPost t·ª´ api.js - t·ª± ƒë·ªông x·ª≠ l√Ω URL v√† errors

    let currentEmail = '';
    let resetToken = '';
    let timerInterval = null;

    // H√†m hi·ªÉn th·ªã alert
    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
      setTimeout(() => {
        alert.classList.remove('show');
      }, 5000);
    }

    // H√†m chuy·ªÉn step
    function goToStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
      });
      document.getElementById(`step${stepNumber}`).classList.add('active');
    }

    // H√†m b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
    function startTimer(seconds) {
      const timerEl = document.getElementById('timer');
      const resendBtn = document.getElementById('resendOtpBtn');
      
      let timeLeft = seconds;
      timerEl.classList.add('active');
      resendBtn.style.display = 'none';

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          timerEl.textContent = 'M√£ OTP ƒë√£ h·∫øt h·∫°n';
          timerEl.classList.remove('active');
          resendBtn.style.display = 'block';
        } else {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          timerEl.textContent = `M√£ h·∫øt h·∫°n sau: ${minutes}:${seconds.toString().padStart(2, '0')}`;
          timeLeft--;
        }
      }, 1000);
    }

    // Step 1: G·ª≠i OTP
    document.getElementById('emailForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const btn = document.getElementById('sendOtpBtn');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang g·ª≠i...';

      try {
        // S·ª≠ d·ª•ng apiPost t·ª´ api.js - t·ª± ƒë·ªông x·ª≠ l√Ω URL v√† errors
        const data = await apiPost('/api/auth/forgot-password', { email });

        if (data.success) {
          currentEmail = email;
          showAlert(data.message || 'M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞!', 'success');
          goToStep(2);
          startTimer(300); // 5 ph√∫t
        } else {
          showAlert(data.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
        }
      } catch (error) {
        console.error('‚ùå Error sending OTP:', error);
        const errorMessage = error.message || error.data?.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!';
        showAlert(errorMessage, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'G·ª≠i m√£ OTP';
      }
    });

    // X·ª≠ l√Ω OTP input
    const otpInputs = document.querySelectorAll('.otp-input');
    otpInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        if (e.target.value.length === 1) {
          if (index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          otpInputs[index - 1].focus();
        }
      });

      // Ch·ªâ cho ph√©p nh·∫≠p s·ªë
      input.addEventListener('keypress', (e) => {
        if (!/[0-9]/.test(e.key)) {
          e.preventDefault();
        }
      });
    });

    // Step 2: X√°c th·ª±c OTP
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const otp = Array.from(otpInputs).map(input => input.value).join('');
      
      if (otp.length !== 6) {
        showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß 6 s·ªë', 'error');
        return;
      }

      const btn = document.getElementById('verifyOtpBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang x√°c th·ª±c...';

      try {
        // S·ª≠ d·ª•ng apiPost t·ª´ api.js - t·ª± ƒë·ªông x·ª≠ l√Ω URL v√† errors
        const data = await apiPost('/api/auth/verify-otp', { 
          email: currentEmail, 
          otp 
        });

        if (data.success) {
          resetToken = data.token;
          showAlert(data.message || 'X√°c th·ª±c th√†nh c√¥ng!', 'success');
          clearInterval(timerInterval);
          goToStep(3);
        } else {
          showAlert(data.message || 'M√£ OTP kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ h·∫øt h·∫°n!', 'error');
          otpInputs.forEach(input => input.value = '');
          otpInputs[0].focus();
        }
      } catch (error) {
        console.error('‚ùå Error verifying OTP:', error);
        const errorMessage = error.message || error.data?.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!';
        showAlert(errorMessage, 'error');
        otpInputs.forEach(input => input.value = '');
        otpInputs[0].focus();
      } finally {
        btn.disabled = false;
        btn.textContent = 'X√°c th·ª±c';
      }
    });

    // G·ª≠i l·∫°i OTP
    document.getElementById('resendOtpBtn').addEventListener('click', async () => {
      const btn = document.getElementById('resendOtpBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang g·ª≠i...';

      try {
        // S·ª≠ d·ª•ng apiPost t·ª´ api.js - t·ª± ƒë·ªông x·ª≠ l√Ω URL v√† errors
        const data = await apiPost('/api/auth/resend-otp', { 
          email: currentEmail 
        });

        if (data.success) {
          showAlert(data.message || 'M√£ OTP m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n', 'success');
          startTimer(300);
          otpInputs.forEach(input => input.value = '');
          otpInputs[0].focus();
        } else {
          showAlert(data.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
        }
      } catch (error) {
        console.error('‚ùå Error resending OTP:', error);
        const errorMessage = error.message || error.data?.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!';
        showAlert(errorMessage, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'G·ª≠i l·∫°i m√£ OTP';
      }
    });

    // Quay l·∫°i nh·∫≠p email
    document.getElementById('backToEmail').addEventListener('click', (e) => {
      e.preventDefault();
      clearInterval(timerInterval);
      otpInputs.forEach(input => input.value = '');
      goToStep(1);
    });

    // Step 3: ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        showAlert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
        return;
      }

      const btn = document.getElementById('resetPasswordBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang x·ª≠ l√Ω...';

      try {
        // S·ª≠ d·ª•ng apiPost t·ª´ api.js - t·ª± ƒë·ªông x·ª≠ l√Ω URL v√† errors
        const data = await apiPost('/api/auth/reset-password', { 
          token: resetToken, 
          newPassword 
        });

        if (data.success) {
          showAlert(data.message || 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
          goToStep(4);
        } else {
          showAlert(data.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
        }
      } catch (error) {
        console.error('‚ùå Error resetting password:', error);
        const errorMessage = error.message || error.data?.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!';
        showAlert(errorMessage, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u';
      }
    });
  </script>
</body>
</html>
