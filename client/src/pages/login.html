<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêƒÉng nh·∫≠p - Edexis</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/client/public/images/edu.png">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-light: rgba(255, 255, 255, 0.9);
      --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 30px 60px rgba(0, 0, 0, 0.15);
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
    }
    .login-container {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 3rem;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-soft);
      position: relative;
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .login-container h2 {
      font-weight: 700;
      color: white;
      text-align: center;
      margin-bottom: 2rem;
    }
    .form-control {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: white;
      font-size: 1rem;
      border-radius: 10px;
      transition: all 0.3s ease;
      padding-right: 45px;
    }
    .form-control:focus {
      background: rgba(255, 255, 255, 0.2);
      border-color: white;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      color: white;
    }
    .form-control::placeholder {
      color: var(--text-light);
      opacity: 0.7;
    }
    .btn-gradient {
      background: var(--secondary-gradient);
      border: none;
      color: white;
      padding: 12px 30px;
      font-weight: 600;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
    .error-message {
      color: #f5576c;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }
    .password-wrapper {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.3s ease;
      z-index: 10;
    }
    .password-toggle:hover {
      color: white;
    }
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    #googleSignInContainer {
      width: 100%;
      margin-bottom: 1rem;
    }
    #googleSignInContainer > div {
      width: 100%;
    }
    /* Style cho Google button ƒë∆∞·ª£c render */
    #googleSignInContainer iframe {
      width: 100% !important;
    }
    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 1.5rem 0;
      color: var(--text-light);
    }
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--glass-border);
    }
    .divider span {
      padding: 0 1rem;
    }
    .role-selection-modal .modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      color: white;
    }
    .role-selection-modal .modal-header {
      border-bottom: 1px solid var(--glass-border);
    }
    .role-selection-modal .modal-body {
      padding: 2rem;
    }
    .role-option {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    .role-option:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: white;
      transform: translateY(-3px);
    }
    .role-option.selected {
      background: var(--secondary-gradient);
      border-color: white;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .role-option i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .role-option h5 {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    @media (max-width: 576px) {
      .login-container {
        margin: 1rem;
        padding: 2rem;
      }
      .login-container h2 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container"></div>
  <div class="login-container" data-aos="zoom-in">
    <h2><i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p v√†o Edexis</h2>
    <form id="loginForm">
      <div class="mb-3">
        <label for="email" class="form-label text-light">Email</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="Nh·∫≠p email" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label text-light">M·∫≠t kh·∫©u</label>
        <div class="password-wrapper">
          <input type="password" class="form-control" id="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
          <i class="fas fa-eye password-toggle" id="togglePassword"></i>
        </div>
      </div>
      <div id="errorMessage" class="error-message mb-3"></div>
      <button type="submit" id="submitButton" class="btn btn-gradient w-100">
        <i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p
      </button>
    </form>
    
    <div class="divider">
      <span>ho·∫∑c</span>
    </div>
    
    <div id="googleSignInContainer" style="display: flex; justify-content: center; margin-bottom: 1rem;">
      <div id="googleSignInButton"></div>
    </div>
    
    <p class="text-center text-light mt-3">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="register.html" class="text-warning">ƒêƒÉng k√Ω</a></p>
    <p class="text-center text-light"><a href="forgot_password.html" class="text-warning">Qu√™n m·∫≠t kh·∫©u?</a></p>
    <p class="text-center mt-3">
      <a href="/client/index.html" class="text-light" style="opacity: 0.8; text-decoration: none; transition: opacity 0.3s;">
        <i class="fas fa-home me-1"></i>Quay l·∫°i trang ch·ªß
      </a>
    </p>
  </div>

  <!-- Modal ch·ªçn role -->
  <div class="modal fade role-selection-modal" id="roleSelectionModal" tabindex="-1" aria-labelledby="roleSelectionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="roleSelectionModalLabel">
            <i class="fas fa-user-tag me-2"></i>Ch·ªçn vai tr√≤ c·ªßa b·∫°n
          </h5>
        </div>
        <div class="modal-body">
          <p class="text-center mb-4">Vui l√≤ng ch·ªçn vai tr√≤ ph√π h·ª£p v·ªõi b·∫°n:</p>
          <div class="role-option" data-role="student">
            <div class="text-center">
              <i class="fas fa-user-graduate"></i>
              <h5>H·ªçc sinh</h5>
              <p class="mb-0">Tham gia c√°c l·ªõp h·ªçc v√† l√†m b√†i ki·ªÉm tra</p>
            </div>
          </div>
          <div class="role-option" data-role="teacher">
            <div class="text-center">
              <i class="fas fa-chalkboard-teacher"></i>
              <h5>Gi√°o vi√™n</h5>
              <p class="mb-0">T·∫°o l·ªõp h·ªçc, b√†i ki·ªÉm tra v√† qu·∫£n l√Ω h·ªçc sinh</p>
            </div>
          </div>
          <button type="button" id="confirmRoleButton" class="btn btn-gradient w-100 mt-3" disabled>
            <i class="fas fa-check me-2"></i>X√°c nh·∫≠n
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
  <!-- Load config v√† API helpers tr∆∞·ªõc -->
  <script src="/client/public/js/config.js"></script>
  <script src="/client/public/js/api.js"></script>
  <script>
    AOS.init({ duration: 800, once: true });

    // Google OAuth Configuration
    const GOOGLE_CLIENT_ID = '1028134720370-jgqmf3pg0p25vjgmhtgj9a4q2rid4t4e.apps.googleusercontent.com';
    let googleToken = null;
    let pendingUserInfo = null;

    // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p b·∫±ng Google
    async function handleGoogleSignIn(response) {
      try {
        googleToken = response.credential;
        console.log('üîê Google Sign-In token nh·∫≠n ƒë∆∞·ª£c');
        showToast('ƒêang x·ª≠ l√Ω ƒëƒÉng nh·∫≠p Google...', 'info');

        // G·ª≠i token l√™n server - s·ª≠ d·ª•ng apiPost t·ª´ api.js
        const data = await apiPost('/api/auth/google', { token: googleToken });
        console.log('üì• Ph·∫£n h·ªìi t·ª´ server:', data);

        if (data.needsRoleSelection) {
          // User m·ªõi - hi·ªÉn th·ªã modal ch·ªçn role
          console.log('üÜï User m·ªõi - Hi·ªÉn th·ªã modal ch·ªçn role');
          pendingUserInfo = data.userInfo;
          showRoleSelectionModal();
        } else if (data.success) {
          // User ƒë√£ t·ªìn t·∫°i - ƒëƒÉng nh·∫≠p th√†nh c√¥ng
          console.log('‚úÖ User ƒë√£ t·ªìn t·∫°i - ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi role:', data.role);
          localStorage.setItem('token', data.token);
          localStorage.setItem('role', data.role);
          showToast('ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng!', 'success');
          
          setTimeout(() => {
            redirectByRole(data.role);
          }, 1000);
        } else {
          console.error('‚ùå L·ªói ƒëƒÉng nh·∫≠p:', data.error);
          showToast(data.error || 'ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i!', 'danger');
        }
      } catch (err) {
        console.error('‚ùå L·ªói ƒëƒÉng nh·∫≠p Google:', err);
        showToast('L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
      }
    }

    // Kh·ªüi t·∫°o Google Sign-In khi trang load
    window.onload = function() {
      // ƒê·ª£i Google API load xong
      function initGoogleSignIn() {
        if (typeof google !== 'undefined' && google.accounts) {
          google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleGoogleSignIn
          });

          // Render Google Sign-In button ch√≠nh th·ª©c
          const container = document.getElementById('googleSignInButton');
          if (container) {
            google.accounts.id.renderButton(container, {
              theme: 'outline',
              size: 'large',
              width: '100%',
              text: 'signin_with',
              locale: 'vi'
            });
          }
        } else {
          // Retry sau 100ms n·∫øu Google API ch∆∞a load
          setTimeout(initGoogleSignIn, 100);
        }
      }
      
      initGoogleSignIn();
    };

    // Hi·ªÉn th·ªã modal ch·ªçn role
    function showRoleSelectionModal() {
      const modal = new bootstrap.Modal(document.getElementById('roleSelectionModal'));
      modal.show();
      
      // Reset selection
      document.querySelectorAll('.role-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.getElementById('confirmRoleButton').disabled = true;
    }

    // X·ª≠ l√Ω ch·ªçn role
    document.querySelectorAll('.role-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        document.getElementById('confirmRoleButton').disabled = false;
      });
    });

    // X·ª≠ l√Ω x√°c nh·∫≠n role
    document.getElementById('confirmRoleButton').addEventListener('click', async () => {
      const selectedRole = document.querySelector('.role-option.selected')?.dataset.role;
      
      if (!selectedRole || !googleToken) {
        showToast('Vui l√≤ng ch·ªçn vai tr√≤!', 'danger');
        return;
      }

      const confirmButton = document.getElementById('confirmRoleButton');
      confirmButton.disabled = true;
      confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';

      try {
        // S·ª≠ d·ª•ng apiPost t·ª´ api.js
        const data = await apiPost('/api/auth/google/complete', {
          token: googleToken,
          role: selectedRole,
          fullName: pendingUserInfo?.name,
          username: pendingUserInfo?.email?.split('@')[0]
        });

        if (data.success) {
          // ƒê√≥ng modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('roleSelectionModal'));
          modal.hide();

          localStorage.setItem('token', data.token);
          localStorage.setItem('role', data.role);
          showToast('ƒêƒÉng k√Ω Google th√†nh c√¥ng!', 'success');

          setTimeout(() => {
            redirectByRole(data.role);
          }, 1000);
        } else {
          showToast(data.error || 'ƒêƒÉng k√Ω th·∫•t b·∫°i!', 'danger');
          confirmButton.disabled = false;
          confirmButton.innerHTML = '<i class="fas fa-check me-2"></i>X√°c nh·∫≠n';
        }
      } catch (err) {
        console.error('L·ªói ho√†n t·∫•t ƒëƒÉng k√Ω:', err);
        showToast('L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
        confirmButton.disabled = false;
        confirmButton.innerHTML = '<i class="fas fa-check me-2"></i>X√°c nh·∫≠n';
      }
    });

    // Chuy·ªÉn h∆∞·ªõng theo role
    function redirectByRole(role) {
      const roleLower = role ? role.toLowerCase() : '';
      switch (roleLower) {
        case 'student':
          window.location.href = './student_dashboard.html';
          break;
        case 'teacher':
          window.location.href = './teacher_dashboard.html';
          break;
        case 'admin':
          window.location.href = './admin.html';
          break;
        default:
          showToast('Vai tr√≤ kh√¥ng h·ª£p l·ªá! Vui l√≤ng li√™n h·ªá h·ªó tr·ª£.', 'danger');
          localStorage.removeItem('token');
          localStorage.removeItem('role');
      }
    }

    // Hi·ªÉn th·ªã toast
    function showToast(message, type = 'danger') {
      const toastContainer = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.role = 'alert';
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      setTimeout(() => toast.remove(), 3000);
    }

    // Hi·ªán/·∫©n m·∫≠t kh·∫©u
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      togglePassword.classList.toggle('fa-eye');
      togglePassword.classList.toggle('fa-eye-slash');
    });

    // ·∫®n th√¥ng b√°o l·ªói khi ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu nh·∫≠p
    const emailInput = document.getElementById('email');
    emailInput.addEventListener('input', () => {
      errorMessage.style.display = 'none';
    });
    passwordInput.addEventListener('input', () => {
      errorMessage.style.display = 'none';
    });

    // X·ª≠ l√Ω submit form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorMessage = document.getElementById('errorMessage');
      const submitButton = document.getElementById('submitButton');

      // Reset tr·∫°ng th√°i
      errorMessage.style.display = 'none';
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';

      // L·∫•y d·ªØ li·ªáu form
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      console.log('D·ªØ li·ªáu g·ª≠i ƒëi:', { email, password }); // Log d·ªØ li·ªáu g·ª≠i ƒëi

      // Ki·ªÉm tra d·ªØ li·ªáu
      if (!email || !password) {
        showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u!', 'danger');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p';
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Email kh√¥ng h·ª£p l·ªá!', 'danger');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p';
        return;
      }

      if (password.length < 6) {
        showToast('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'danger');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p';
        return;
      }

      // G·ª≠i request
      const formData = { email, password };
      try {
        // S·ª≠ d·ª•ng apiPost t·ª´ api.js - t·ª± ƒë·ªông x·ª≠ l√Ω JSON v√† errors
        const data = await apiPost('/api/auth/login', formData);
        console.log('D·ªØ li·ªáu JSON:', data); 

        localStorage.setItem('token', data.token);
        localStorage.setItem('role', data.role); 

        showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');

        // Chuy·ªÉn trang theo role
        setTimeout(() => {
          redirectByRole(data.role);
        }, 1000);
      } catch (err) {
        console.error('L·ªói chi ti·∫øt:', err); 
        
        // L·∫•y th√¥ng b√°o l·ªói t·ª´ server
        let errorText = 'L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.';
        if (err.data) {
          errorText = err.data.message || err.data.error || errorText;
        } else if (err.message && !err.message.includes('Failed to fetch')) {
          errorText = err.message;
        }
        
        // Hi·ªÉn th·ªã l·ªói trong errorMessage element
        errorMessage.style.display = 'block';
        errorMessage.textContent = errorText;
        
        // C≈©ng hi·ªÉn th·ªã toast ƒë·ªÉ ng∆∞·ªùi d√πng d·ªÖ nh·∫≠n th·∫•y
        showToast(errorText, 'danger');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p';
      }
    });
  </script>
</body>
</html>